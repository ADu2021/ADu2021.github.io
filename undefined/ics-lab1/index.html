<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?bb5ac2cda14d75e964628a6860376b85";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content=""/>
  <meta name="keyword" content="adu2021,duyy,livemylife"/>
  <link rel="shortcut icon" href="/img/avatar/code-face.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://adu2021.github.io/undefined/ics-lab1/">
  <title>
    
      ICS-LAB1-Coroutine - ADu&#39;s Blog
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'your-community/your-room'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">ADu&#39;s Blog</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: url('');
      --intro-header-background-image-url-page: url('/img/header_img/archive_bg2.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/archive_bg2.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url(''); */
      
    }

    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#ICS" title="ICS">ICS</a>
              
            </div>
            <h1>ICS-LAB1-Coroutine</h1>
            <h2 class="subheading">好酷炫&amp;&amp;我也不想写这么多</h2>
            <span class="meta">
              Posted by Du Yiyang on
              2023-01-23
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">14</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">3.6k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h1>ICS LAB1 Coroutine Report</h1>
<p>2022秋</p>
<h2 id="Task1：基础协程库">Task1：基础协程库</h2>
<h3 id="代码实现">代码实现</h3>
<ol>
<li>
<p>调度：完善了 coroutine_pool.h 中的 serial_execute_all 函数。首先记录未完成协程数 num ，然后当 num&gt;0 时，遍历协程池中的所有协程并选择一个 resume() ，并在调用前记录当前 context_id ，在协程将控制权交回时判断是否 finish ，若是则 num-- 。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coroutines.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line"> <span class="keyword">if</span>(!coroutines[i]-&gt;finished) &#123;</span><br><span class="line">     num++; <span class="comment">// num 表示尚未完成的协程数</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> (num &gt; <span class="number">0</span>) &#123; <span class="comment">// 还有尚未完成的协程</span></span><br><span class="line"> <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coroutines.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">     <span class="keyword">if</span>(!coroutines[i]-&gt;ready &amp;&amp; coroutines[i]-&gt;<span class="built_in">ready_func</span>()) </span><br><span class="line">         coroutines[i]-&gt;ready = <span class="literal">true</span>;</span><br><span class="line">     <span class="keyword">if</span> (coroutines[i]-&gt;ready &amp;&amp; !coroutines[i]-&gt;finished) &#123; <span class="comment">// 尚未完成，但准备好的协程</span></span><br><span class="line">         context_id = i; <span class="comment">// 标记 context_id ，便于 yield 和 sleep 找到对应的上下文使用</span></span><br><span class="line">         coroutines[i]-&gt;<span class="built_in">resume</span>(); <span class="comment">// 转移控制权</span></span><br><span class="line">         <span class="keyword">if</span> (coroutines[i]-&gt;finished) &#123; <span class="comment">// 当控制权回到协程池时，判断是否完成</span></span><br><span class="line">             num--; <span class="comment">// 若是，则尚未完成的协程数减少1</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>swap：完善了 context.S 中的汇编代码。首先保存了 %rsp, %rbx, %rbp, %r12, %r13, %14, %15 这几个 callee-saved register 到 offset(%rdi) 中，其中 offset 顺序要与 context.h 中 enum 类型声明的一致。特别注意由于后面返回并不是用 ret 而是 jumpq ，所以应当存储 8(%rsp) ，这样跳转的时候才能相当于把返回地址从栈中弹出，使栈完全还原。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">coroutine_switch:</span><br><span class="line"> # TODO: Task 1</span><br><span class="line"> # 保存 callee-saved 寄存器到 %rdi 指向的上下文</span><br><span class="line"> # 上文解释过的“特别注意存储 8(%rsp)</span><br><span class="line"> leaq 8(%rsp), %rax</span><br><span class="line"> movq %rax, 64(%rdi)</span><br><span class="line"> movq %rbx, 72(%rdi)</span><br><span class="line"> movq %rbp, 80(%rdi)</span><br><span class="line"> movq %r12, 88(%rdi)</span><br><span class="line"> movq %r13, 96(%rdi)</span><br><span class="line"> movq %r14, 104(%rdi)</span><br><span class="line"> movq %r15, 112(%rdi)</span><br><span class="line"> # 保存的上下文中 rip 指向 ret 指令的地址</span><br><span class="line"> # 这里没有用到 $.coroutine_ret，而是直接读了 (%rsp) 的栈顶返回地址</span><br><span class="line"> movq (%rsp), %rax</span><br><span class="line"> movq %rax, 120(%rdi)</span><br><span class="line"></span><br><span class="line"> # 从 %rsi 指向的上下文恢复 callee-saved 寄存器</span><br><span class="line"> movq 64(%rsi), %rsp</span><br><span class="line"> movq 72(%rsi), %rbx</span><br><span class="line"> movq 80(%rsi), %rbp</span><br><span class="line"> movq 88(%rsi), %r12</span><br><span class="line"> movq 96(%rsi), %r13</span><br><span class="line"> movq 104(%rsi), %r14</span><br><span class="line"> movq 112(%rsi), %r15</span><br><span class="line"> # 最后 jmpq 到上下文保存的 rip</span><br><span class="line"> jmpq *120(%rsi)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>主动切出：在 coroutine_context.resume() 中，通过调用 coroutine_switch 函数将当前（协程池）状态存到 caller_registers 中，然后将控制权交给协程自己存储的的 callee_registers 状态中继续执行。反过来，在 common.h 中实现的 yield() 函数则将当前 context 的状态保存到 callee_registers，将控制权转移回 caller_registers。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">resume</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="comment">// 在汇编中保存 callee-saved 寄存器，设置协程函数栈帧，然后将 rip 恢复到协程 yield 之后所需要执行的指令地址。</span></span><br><span class="line"> <span class="built_in">coroutine_switch</span>(caller_registers, callee_registers);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">yield</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="keyword">if</span> (!g_pool-&gt;is_parallel) &#123;</span><br><span class="line"> <span class="comment">// 从 g_pool 中获取当前协程状态</span></span><br><span class="line"> <span class="keyword">auto</span> context = g_pool-&gt;coroutines[g_pool-&gt;context_id];</span><br><span class="line"> <span class="comment">// 调用 coroutine_switch 切换到 coroutine_pool 上下文</span></span><br><span class="line"> <span class="built_in">coroutine_switch</span>(context-&gt;callee_registers, context-&gt;caller_registers);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="额外报告">额外报告</h3>
<ol>
<li>协程切换时，栈的变化过程</li>
</ol>
<p>如图是协程切换时，栈的变化过程。值得注意的是 <code>movq 64(%rsi), %rsp</code> 语句将 %rsi 处保存的 %rsp 恢复，这意味着当前（运行）栈帧发生了变化。图上新的栈顶地址更高一些，但实际上这大小关系并不确定。</p>
<p><img src="https://i.imgur.com/dbh258W.png" alt=""></p>
<ol>
<li>分析源代码</li>
</ol>
<p>首先分析初始的协程状态：在 basic_context 的构造函数中，首先申请了 stack_size 个字节大小的空间，这部分空间将作为以后栈生长的空间。随后，将 %rsp 指向了这段空间和 16 字节对齐的高地址。（满足对齐要求，同时栈是向低地址生长的）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stack = <span class="keyword">new</span> <span class="keyword">uint64_t</span>[stack_size];</span><br><span class="line"><span class="keyword">uint64_t</span> rsp = (<span class="keyword">uint64_t</span>)&amp;stack[stack_size - <span class="number">1</span>];</span><br><span class="line">rsp = rsp - (rsp &amp; <span class="number">0xF</span>);</span><br><span class="line">callee_registers[(<span class="keyword">int</span>)Registers::RSP] = rsp;</span><br></pre></td></tr></table></figure>
<p>然后，协程的初始代码（rip）被指向了 coroutine_entry ，这是一段用于调用 coroutine_main 的汇编，而 coroutine_main 的地址及其形参 this 被存在了 %r12 和 %r13 中。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">callee_registers[(<span class="keyword">int</span>)Registers::RIP] = (<span class="keyword">uint64_t</span>)coroutine_entry;</span><br><span class="line">callee_registers[(<span class="keyword">int</span>)Registers::R12] = (<span class="keyword">uint64_t</span>)coroutine_main;</span><br><span class="line">callee_registers[(<span class="keyword">int</span>)Registers::R13] = (<span class="keyword">uint64_t</span>)<span class="keyword">this</span>;</span><br></pre></td></tr></table></figure>
<p>这里的巧妙之处在于：由于 %rdi 不是 callee-saved register ，我们不能利用协程的 coroutine_switch 机制直接传递参数，但是我们可以先将函数地址和参数存在 callee-saved register 中（这里是 %r12 和 %r13），然后用一段初始代码将存放在callee-saved register 中参数 mov 到 %rdi 中，然后以 %r12 中的地址为索引间接调用 coroutine_main。这段初始代码便是 coroutine_entry 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">coroutine_entry:</span><br><span class="line">    movq %r13, %rdi</span><br><span class="line">    callq *%r12</span><br></pre></td></tr></table></figure>
<p>coroutine_entry 调用 coroutine_main ，后者相当于这个协程的“主函数”，首先执行协程携带的那个函数，在执行完成之后标记 <code>finished = true</code> 代表完成，最后通过 coroutine_switch 将控制权还回 caller_registers 所对应的上下文（也就是给它控制权的协程池）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">coroutine_main</span><span class="params">(struct basic_context *context)</span> </span>&#123;</span><br><span class="line">    context-&gt;<span class="built_in">run</span>();</span><br><span class="line">    context-&gt;finished = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">coroutine_switch</span>(context-&gt;callee_registers, context-&gt;caller_registers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是，上面的 <code>context-&gt;run()</code> 的过程不一定是连续的——可能会主动调用 <code>yield()</code> ，这时候会将当前上下文存到 callee_registers 中，然后直接将控制权交回给协程池。此后，在调用 <code>resume()</code> 的时候，将 callee_registers 的状态读出来，即可实现协程的原地恢复。（yield 和 resume 代码上面已经分析过了）</p>
<p>最后，当用户（sample.cpp）调用协程池的 <code>serial_execute_all()</code> 函数后，只要还有没进行完的协程，协程池就会找到一个 ready 的协程，然后通过 resume() 把控制权交给这个协程。特别地，当这个协程是第一次执行的时候，它会按照初始化的 rip 先去调用 coroutine_entry ，然后按照前面分析的方式由 coroutine_main 主导整个协程的进行。</p>
<h2 id="Task2：Sleep-Sort">Task2：Sleep Sort</h2>
<h3 id="代码实现-2">代码实现</h3>
<p>在 commom.h 中，完善了 sleep 函数，在根据当前时间设置 ready_func 后把上下文交回给协程池。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> context = g_pool-&gt;coroutines[g_pool-&gt;context_id]; <span class="comment">// 从 g_pool 中获取当前协程状态</span></span><br><span class="line"><span class="keyword">auto</span> cur = <span class="built_in">get_time</span>(); <span class="comment">// 获取当前时间，更新 ready_func</span></span><br><span class="line"><span class="comment">// ready_func：检查当前时间，如果已经超时，则返回 true</span></span><br><span class="line">context-&gt;ready_func = [cur, ms]() -&gt;<span class="keyword">bool</span> &#123; </span><br><span class="line">      <span class="keyword">return</span> std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(<span class="built_in">get_time</span>() - cur).<span class="built_in">count</span>() &gt;= ms;</span><br><span class="line">&#125;; </span><br><span class="line">context-&gt;ready = <span class="literal">false</span>; <span class="comment">// 设置当前协程为不可用状态</span></span><br><span class="line"><span class="built_in">coroutine_switch</span>(context-&gt;callee_registers, context-&gt;caller_registers); <span class="comment">// 调用 coroutine_switch 切换到 coroutine_pool 上下文</span></span><br></pre></td></tr></table></figure>
<p>在 coroutine_pool.h 中，判断当协程未 ready 但是 ready_func() 给出时间已经到了的时候，将 ready 设置为 true。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!coroutines[i]-&gt;ready &amp;&amp; coroutines[i]-&gt;<span class="built_in">ready_func</span>()) </span><br><span class="line">    coroutines[i]-&gt;ready = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h3 id="额外报告-2">额外报告</h3>
<ol>
<li>
<p>考虑如下输入（ <a target="_blank" rel="noopener" href="http://README.md">README.md</a> 给出的）：</p>
<blockquote>
<p>5 <br><br>
1 3 4 5 2</p>
</blockquote>
</li>
</ol>
<p>协程运行的情况如下：</p>
<p><img src="https://i.imgur.com/rKMnylY.png" alt=""></p>
<p>注：图上的 t=0，t=1，… 是建立在运行时间远大于等待时间（如前5次resume与sleep调用时间小于1ms）的情况的，这里如此标注是为了明确区分不同的时间段，<em>执行顺序并没有差别</em>。</p>
<ol>
<li>更加高效的方法：</li>
</ol>
<p>对于Task2，可以维护一个优先队列 pq ，在调用 sleep(int x) 的时候，不用 ready_func ，而是直接将二元组 (current_time+x, context_id) 加入到优先队列 pq 中（current_time 是当前时间(ms)，context_id 是当前协程标号），pq 按二元组第一元素升序排。这样，在协程池选择协程 resume 的时候，就不需要轮询 <code>ready_func</code> 是否等于 <code>true</code> ，而是只需取 pq 的队头元素，若其时间大于当前时间则 resume，否则等待下一轮询问。</p>
<p>对于其他问题，如果协程的 ready 状态是“主动的”，即在已知的有限个位置会将协程的 ready 由 false 置为 true （如带 callback 的 I/O 操作），则可以维护一个 Stack/Queue ，在一个尚未 finish 的协程 ready 状态改变成 true  后主动将其放入 Stack/Queue 中，也能实现不用轮询，直接选择 Stack/Queue 中的首元素 resume 即可。</p>
<h2 id="Task3：优化二分查找">Task3：优化二分查找</h2>
<h3 id="代码实现-3">代码实现</h3>
<p>完善了协程优化的带 __builtin_prefetch 的二分查找。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lookup_coroutine</span><span class="params">(<span class="keyword">const</span> <span class="keyword">uint32_t</span> *table, <span class="keyword">size_t</span> size, <span class="keyword">uint32_t</span> value, <span class="keyword">uint32_t</span> *result)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> low = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((size / <span class="number">2</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> half = size / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">size_t</span> probe = low + half;</span><br><span class="line">        <span class="comment">// 使用 __builtin_prefetch 预取容易产生缓存缺失的内存</span></span><br><span class="line">        __builtin_prefetch(table + probe, <span class="number">0</span>, <span class="number">3</span>); <span class="comment">// rw=0:read, locality=3 表示随后还会经常用到</span></span><br><span class="line">        <span class="built_in">yield</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint32_t</span> v = table[probe];</span><br><span class="line">        <span class="keyword">if</span> (v &lt;= value) &#123;</span><br><span class="line">        low = probe;</span><br><span class="line">        &#125;</span><br><span class="line">        size -= half;</span><br><span class="line">    &#125;</span><br><span class="line">    *result = low;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="性能分析">性能分析</h3>
<p>以下从 prefetch 方式和 Data size, Loops count, Batch size 多个因素考虑协程优化的二分查找效率。</p>
<p>定义优化比例 <code>p = (t0-t)/t0</code> ，其中 t0 为 naive 方式耗时，t 为 coroutine batched 方式耗时。</p>
<h4 id="prefetch-方式对协程优化二分查找效率的影响">prefetch 方式对协程优化二分查找效率的影响</h4>
<ol>
<li><code>__builtin_prefetch(table + probe, 0, 3)</code> 函数的最后一个参数 locality “时间局部性”刻画如果某数据被访问后，不久之后该数据会被再次访问的可能性，取值从0到3，表示再次访问的可能性依次增加。考察上述代码在 Size=4294967296, Loops=1280000, Batch_size=16 的条件下，不同 locality 设置的表现。重复5次取每次 search 耗时平均值，有：</li>
</ol>
<p>[locality = 3] naive: 1935.99 ns  |  coroutine batched : 1345.09 ns | p = 0.305</p>
<p>[locality = 2] naive: 1934.30 ns  |  coroutine batched : 1346.64 ns | p = 0.304</p>
<p>[locality = 1] naive: 1942.80 ns  |  coroutine batched : 1344.99 ns | p = 0.308</p>
<p>[locality = 0] naive: 1935.99 ns  |  coroutine batched : 1381.79 ns | p = 0.286</p>
<p>可知，除 locality = 0 会使得优化率降低外， locality = 1,2,3 无明显差别。</p>
<ol start="2">
<li>
<p>曾经有如下的 prefetch 尝试：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__builtin_prefetch(table + probe, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">__builtin_prefetch(table + low + ((size - (size) &gt;&gt; <span class="number">1</span>) &gt;&gt; <span class="number">1</span>), <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">__builtin_prefetch(table + probe + ((size - (size) &gt;&gt; <span class="number">1</span>) &gt;&gt; <span class="number">1</span>), <span class="number">0</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<p>后两个额外的 prefetch 是下一层二分查找的两个可能的 probe 位置。性能如下：</p>
</li>
</ol>
<p>naive: 1986.67 ns  |  coroutine batched : 1455.14 ns | p = 0.268</p>
<p>和上面只进行一次 prefetch 的 [locality = 3] 的比较，优化率有所下降，这可能是由于后面两个 prefetch 再下一次循环中会作为第一次 prefetch 调用，所以这部分冗余带来的惩罚要比提前 prefetch 带来的优化要多。</p>
<h4 id="Data-size-对协程优化二分查找效率的影响">Data size 对协程优化二分查找效率的影响</h4>
<p>下图中，横坐标为 <strong>log2</strong>(data_size)，可以观察到规模在 2^26 以下的数据，对照组更优，而更大的数据规模下协程优化才能体现出来。理论上一次二分查找的复杂度是 log(data_size) 的，在图上应该是线性的，但是注意 naive 在 2^23 ，coroutine 在 2^26 之后都表现出更大的增长速率，说明协程优化更能抵抗极大数据规模下的性能下降。</p>
<p><img src="https://i.imgur.com/aAiwPpG.png" alt=""></p>
<p><em>所有统计图中，纵坐标均为单次二分查找耗时，黄线为 coroutine 优化，蓝线为 naive 对照</em></p>
<h4 id="Loops-count-对协程优化二分查找效率的影响">Loops count 对协程优化二分查找效率的影响</h4>
<p><img src="https://i.imgur.com/YBStqsS.png" alt=""></p>
<p>上图中，横坐标为 <strong>log2</strong>(loops_count) ，注意到在 loops_count &gt; 2^15 后，单次查询耗时趋于稳定，这符合预期（总的查询量不应当影响单次查询效率）。loops_count 较小时可能由于一些共有常数耗时，分摊到每次查询时较大，可以忽略。</p>
<h4 id="Batch-size-对协程优化二分查找效率的影响">Batch size 对协程优化二分查找效率的影响</h4>
<p>通过 -b 参数调整每组询问的 batch size ，观察效率的变化( Size: 4294967296 Loops: 1600000 ， locality = 3)</p>
<p>[batch size = 1 ] naive: 1963.35ns  |  coroutine batched : 2728.01ns  |  p = -0.389 (batch size = 1 当然是负优化了)</p>
<p>[batch size = 2 ] naive: 1956.35ns  |  coroutine batched : 1593.66ns  |  p = 0.177</p>
<p>[batch size = 4 ] naive: 1956.60ns  |  coroutine batched : 1210.99ns  |  p = 0.381</p>
<p>[batch size = 8 ] naive: 1942.12ns  |  coroutine batched : 1228.17ns  |  p = 0.367</p>
<p>[batch size = 16] naive: 1935.99ns  |  coroutine batched : 1345.09ns  |  p = 0.305</p>
<p>[batch size = 32] naive: 2045.57ns  |  coroutine batched : 2337.57ns  |  p = -0.143 （batch 过大，负优化）</p>
<p>可以发现，对于很大的（&gt;=32） batch size，用协程 prefetch 优化的方法是负优化，这可能是由于在 batch size 很大的情况下协程池中的协程数很多，每个在开始执行后都 prefetch 然后 yield，就相当于同时prefetch 了很多段内存，而这是十分低效的（因为 prefetch 希望精确的指出数量较少的将要访问的内存），并且随着 batch size 的增加，负优化会越明显。</p>
<p>此外，对于不同的 batch size ，优化的程度也会不同，由上可知本方法对于 batch size = 4 附近的数据效果最好，平均的优化率 p = 0.381，在实际测试时有时还能做到 p &gt; 0.6 ，<strong>说明在这些情况下能够显著优化而分叉找效率</strong>。</p>
<p>值得注意的是，batch size 的优化效果并不是单峰的，而是呈现某种周期性变化：下图中横坐标为 batch size ，在一小段区间内耗时随着 batch size 升高而近乎线性地增加，然而每次当 batch_size = 2^k + 1 时，耗时会断崖式下降。这可能与系统 cache 机制有关：当 batch_size 恰好为2的幂时，会有很多的内存被 mapping 到同一 cache 里，使得 prefetch 效率降低。</p>
<p><img src="https://i.imgur.com/fDdYNGK.png" alt=""></p>
<h4 id="鲁棒性提升">鲁棒性提升</h4>
<p>在实际测试时会有十分有趣的现象：对于同样的数据，不同时间给出的测试结果会有一定的波动。这种波动可能是服务器，I/O 不稳定性等多种原因导致的，观察下面这几组结果（和每组后面额外计算的优化率）：</p>
<p>naive: 5558.75 ns per search, 173.71 ns per access</p>
<p>coroutine batched: 1521.32 ns per search, 47.54 ns per access<br>
[p = 0.726]</p>
<p>naive: 6868.95 ns per search, 214.65 ns per access</p>
<p>coroutine batched: 1323.06 ns per search, 41.35 ns per access<br>
[p = 0.807]</p>
<p>naive: 5063.57 ns per search, 158.24 ns per access</p>
<p>coroutine batched: 1328.68 ns per search, 41.52 ns per access<br>
[p = 0.738]</p>
<p>以上三组数据的优化率很大，能到 0.7 甚至 0.8，并且有时在服务器上频繁的出现这种 case。<em>前面的分析中都去掉了这种特殊情况。</em> 观察它们 naive 和 coroutine batched 的数据，和前面相比，发现优化率的提升主要是由于在该环境下 naive 的二分查找速度显著变慢，然而 coroutine batched 的时间增加很不明显。这说明，协程 prefetch 优化不仅能够在稳定时提升速度，还能在系统 I/O 等原因导致的波动时运行时间几乎不受影响，表现出强鲁棒性。</p>
<h4 id="测试环境">测试环境</h4>
<p>以上测试数据中，用文字描述的是在课程提供的服务器上进行的(Intel® Xeon® CPU E5-4610 v2 @ 2.30GHz, 32GB RAM, Ubuntu 20.04, x86_64)。</p>
<p>图片描述的数据是在本地获得的(12th Gen Intel® Core™ i5-12500H   2.50 GHz, 16GB RAM, Ubuntu 22.04, x86_64)。</p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/undefined/ics-lab2/" data-toggle="tooltip" data-placement="top" title="ICS-LAB2-Attack">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/undefined/summary2022fall/" data-toggle="tooltip" data-placement="top" title="大二上学期总结">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=ICS-LAB1-Coroutine&body=Hi,I found this website and thought you might like it https://adu2021.github.io/undefined/ics-lab1/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: 'ff75338a1add7ef1c2c6',
      clientSecret: '0d3daff08fa21827ac90b2682d812688a20635ee',
      repo: 'adu2021.github.io',
      owner: 'ADu2021',
      admin: 'ADu2021',
      id: 'Mon Jan 23 2023 20:24:18 GMT+0000', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'zh-CN',
      proxy: 'https://shielded-brushlands-08810.herokuapp.com/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">ICS LAB1 Coroutine Report</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Task1%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%8D%8F%E7%A8%8B%E5%BA%93"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">Task1：基础协程库</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-nav-number">1.1.1.</span> <span class="toc-nav-text">代码实现</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%A2%9D%E5%A4%96%E6%8A%A5%E5%91%8A"><span class="toc-nav-number">1.1.2.</span> <span class="toc-nav-text">额外报告</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Task2%EF%BC%9ASleep-Sort"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">Task2：Sleep Sort</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-2"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">代码实现</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%A2%9D%E5%A4%96%E6%8A%A5%E5%91%8A-2"><span class="toc-nav-number">1.2.2.</span> <span class="toc-nav-text">额外报告</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Task3%EF%BC%9A%E4%BC%98%E5%8C%96%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">Task3：优化二分查找</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-3"><span class="toc-nav-number">1.3.1.</span> <span class="toc-nav-text">代码实现</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-nav-number">1.3.2.</span> <span class="toc-nav-text">性能分析</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#prefetch-%E6%96%B9%E5%BC%8F%E5%AF%B9%E5%8D%8F%E7%A8%8B%E4%BC%98%E5%8C%96%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE%E6%95%88%E7%8E%87%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-nav-number">1.3.2.1.</span> <span class="toc-nav-text">prefetch 方式对协程优化二分查找效率的影响</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Data-size-%E5%AF%B9%E5%8D%8F%E7%A8%8B%E4%BC%98%E5%8C%96%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE%E6%95%88%E7%8E%87%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-nav-number">1.3.2.2.</span> <span class="toc-nav-text">Data size 对协程优化二分查找效率的影响</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Loops-count-%E5%AF%B9%E5%8D%8F%E7%A8%8B%E4%BC%98%E5%8C%96%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE%E6%95%88%E7%8E%87%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-nav-number">1.3.2.3.</span> <span class="toc-nav-text">Loops count 对协程优化二分查找效率的影响</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Batch-size-%E5%AF%B9%E5%8D%8F%E7%A8%8B%E4%BC%98%E5%8C%96%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE%E6%95%88%E7%8E%87%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-nav-number">1.3.2.4.</span> <span class="toc-nav-text">Batch size 对协程优化二分查找效率的影响</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E9%B2%81%E6%A3%92%E6%80%A7%E6%8F%90%E5%8D%87"><span class="toc-nav-number">1.3.2.5.</span> <span class="toc-nav-text">鲁棒性提升</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83"><span class="toc-nav-number">1.3.2.6.</span> <span class="toc-nav-text">测试环境</span></a></li></ol></li></ol></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#ICS" title="ICS">ICS</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/ADu2021">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Du Yiyang
          2023
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("https://adu2021.github.io/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
